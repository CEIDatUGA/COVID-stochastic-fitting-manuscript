---
title: "Filtered States Fits"
author: "Andrew Tredennick"
date: '2022-06-15'
output: html_document
---

```{r, include=TRUE, eval = TRUE, echo=FALSE, warning=FALSE}
library(tidyverse)

all_files <- list.files("./output/")
states <- lapply(str_split(all_files, "-"), `[[`, 1) %>%
  unlist() %>%
  unique()
states <- states[states != "placeholder"]

for(s in states) {
  files <- all_files[grepl(s, all_files)]
  fs_file <- paste0("./output/", files[grepl("filtered_states", files)])
  po_file <- paste0("./output/", files[grepl("res_2", files)])
  
  filtered_states <- readRDS(fs_file)
  pomp_model <- readRDS(po_file)
  pomp_model <- pomp_model$pomp_model
  
  dat <- t(pomp_model@data) %>%
    as.data.frame() %>%
    mutate(time = 1:n()) %>%
    dplyr::select(time, cases, deaths) %>%
    pivot_longer(cols = cases:deaths)
  
  covar <- t(pomp_model@covar@table) %>%
    as.data.frame() %>%
    dplyr::select(rel_beta_change) %>%
    mutate(time = 1:n()) %>%
    rename("mobility" = rel_beta_change)
  
  ests <- filtered_states %>%
    dplyr::select(time, C_new, D_new, trendO) %>%
    mutate(latent_trend = exp(trendO) / (1+exp(trendO))) %>%
    dplyr::select(-trendO) %>%
    rename("cases" = C_new,
           "deaths" = D_new) %>%
    left_join(covar, by = "time") %>%
    pivot_longer(cols = cases:mobility) %>%
    group_by(time, name) %>%
    summarise(mean = mean(value, na.rm = TRUE),
              lower = quantile(value, 0.025, na.rm = TRUE),
              upper = quantile(value, 0.975, na.rm = TRUE),
              .groups = "drop") 
  
  p <- ggplot() +
    geom_point(data = dat, aes(x = time, y = value)) +
    geom_ribbon(data = ests,
                aes(x = time, ymin = lower, ymax = upper), 
                alpha = 0.25, 
                fill = "blue") +
    geom_line(data = ests, aes(x = time, y = mean), color = "blue", size= 1) +
    facet_wrap(~name, scales = "free_y") +
    ggtitle(s)
  plot(p)
}


```